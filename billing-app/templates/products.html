{{ define "title" }}Produits - Billing App{{ end }} {{ define "content" }}
<section class="mx-auto max-w-7xl px-6 py-10 space-y-10">
  <!-- Header -->
  <header
    class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
  >
    <div>
      <h1 class="text-3xl font-extrabold tracking-tight">Produits</h1>
      <p class="text-sm opacity-70 mt-1">Gestion du catalogue & tarifs</p>
    </div>
    <div class="flex gap-2">
      <a href="/dashboard" class="btn btn-outline btn-sm">‚Üê Dashboard</a>
      {{ if not .NoCompany }}
      <button
        type="button"
        class="btn btn-primary btn-sm"
        onclick="productModal.showModal()"
      >
        Nouveau
      </button>
      {{ end }}
    </div>
  </header>

  <!-- Errors / Notices -->
  {{ if .Errors }}
  <div class="alert alert-error text-xs">
    <span class="font-medium">Erreurs de validation</span>
    <ul class="list-disc ml-4 space-y-0.5">
      {{ range $k,$v := .Errors }}
      <li><strong>{{ $k }}</strong> : {{ $v }}</li>
      {{ end }}
    </ul>
  </div>
  {{ end }} {{ if .NoCompany }}
  <div class="alert alert-warning">
    <span>Aucune soci√©t√© configur√©e.</span>
    <a href="/setup" class="btn btn-sm btn-outline ml-auto">Configurer</a>
  </div>
  {{ end }}

  <!-- Stats -->
  <div class="grid gap-4 sm:grid-cols-3">
    <div class="stat-card">
      <p class="stat-label">Total produits</p>
      <p class="stat-value">
        {{ if .Products }}{{ len .Products }}{{ else }}0{{ end }}
      </p>
    </div>
    <div class="stat-card">
      <p class="stat-label">Prix moyen</p>
      <p class="stat-value">
        {{ if .Products }}{{ printf "%.2f" (avgPrice .Products) }}‚Ç¨{{ else }}‚Äî{{
        end }}
      </p>
    </div>
    <div class="stat-card">
      <p class="stat-label">Derni√®re cr√©ation</p>
      <p class="stat-value">
        {{ if .Products }}{{ (index .Products 0).CreatedAt.Format "2006-01-02"
        }}{{ else }}‚Äî{{ end }}
      </p>
    </div>
  </div>

  <!-- Catalogue Table -->
  <div class="card bg-base-100 border border-base-200">
    <div
      class="p-4 flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
    >
      <h2 class="text-lg font-semibold">Catalogue</h2>
      <div class="flex items-center gap-2">
        <label
          class="input input-sm input-bordered flex items-center gap-2"
          aria-label="Filtrer les produits"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 opacity-60"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-4.35-4.35M17 10.5A6.5 6.5 0 104 10.5a6.5 6.5 0 0013 0z"
            />
          </svg>
          <input
            id="prodFilter"
            type="text"
            placeholder="Filtrer..."
            class="grow"
            oninput="filterProducts()"
          />
        </label>
        {{ if not .NoCompany }}<button
          type="button"
          class="btn btn-primary btn-sm"
          onclick="productModal.showModal()"
        >
          Ajouter</button
        >{{ end }}
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="table table-sm" aria-describedby="prodCount">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nom / Code</th>
            <th>Type</th>
            <th>Unit√©</th>
            <th class="text-right">Prix HT (‚Ç¨)</th>
            <th class="text-right">TVA (%)</th>
            <th>Cr√©√©</th>
          </tr>
        </thead>
        <tbody id="prodRows">
          {{ range .Products }}
          <tr data-name="{{ .Name | html }}" data-id="{{ .ID }}" data-code="{{ .Code }}" data-price="{{ printf "%.2f" .UnitPrice }}" data-vat="{{ printf "%.2f" (mul .VATRate 100) }}">
            <td class="font-medium">{{ .ID }}</td>
            <td>
              <span class="block font-medium">{{ .Name }}</span>
              <span class="text-[10px] tracking-wide opacity-60">{{ .Code }}</span>
            </td>
            <td>{{ if .ProductType }}{{ .ProductType.Name }}{{ end }}</td>
            <td>{{ if .UnitType }}{{ .UnitType.Symbol }}{{ end }}</td>
            <td class="text-right">{{ printf "%.2f" .UnitPrice }}</td>
            <td class="text-right">{{ printf "%.2f" (mul .VATRate 100) }}</td>
            <td class="whitespace-nowrap">
              <div class="flex items-center gap-2">
                <span>{{ .CreatedAt.Format "2006-01-02" }}</span>
                <button type="button" class="btn btn-ghost btn-xs" onclick="openEdit(this)" title="Editer">‚úèÔ∏è</button>
                <form method="post" action="/products/delete" onsubmit="return confirm('Supprimer ce produit ?');">
                  <input type="hidden" name="id" value="{{ .ID }}" />
                  <button type="submit" class="btn btn-ghost btn-xs" title="Supprimer">üóëÔ∏è</button>
                </form>
              </div>
            </td>
          </tr>
          {{ else }}
          <tr>
            <td colspan="5" class="text-center py-8 opacity-60 text-sm">
              Aucun produit
            </td>
          </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
  </div>
</section>

{{ if not .NoCompany }}
<dialog id="productModal" class="modal">
  <div class="modal-box w-full max-w-md">
    <form method="dialog">
      <button
        class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
        title="Fermer"
      >
        ‚úï
      </button>
    </form>
  <h3 id="modalTitle" class="font-semibold text-lg mb-4">Nouveau produit</h3>
  <form id="productForm" method="post" action="/products" class="space-y-4" novalidate>
      <div class="grid grid-cols-3 gap-4">
        <div class="form-control col-span-2">
          <label for="name" class="label py-1"
            ><span class="label-text text-xs font-medium">Nom *</span></label
          >
          <input
            required
            id="name"
            name="name"
            class="input input-bordered input-sm"
          />
        </div>
        <div class="form-control">
          <label for="code" class="label py-1"
            ><span class="label-text text-xs font-medium">Code *</span></label
          >
          <input
            required
            id="code"
            name="code"
            maxlength="40"
            class="input input-bordered input-sm uppercase"
            placeholder="SKU-001"
          />
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="form-control">
          <label for="unit_price" class="label py-1"
            ><span class="label-text text-xs font-medium"
              >Prix HT (‚Ç¨) *</span
            ></label
          >
          <input
            required
            id="unit_price"
            name="unit_price"
            type="number"
            step="0.01"
            min="0"
            class="input input-bordered input-sm"
          />
        </div>
        <div class="form-control">
          <label for="vat_rate" class="label py-1"
            ><span class="label-text text-xs font-medium">TVA (%)</span></label
          >
          <input
            id="vat_rate"
            name="vat_rate"
            type="number"
            step="0.01"
            min="0"
            max="100"
            value="20"
            class="input input-bordered input-sm"
          />
          <p class="mt-1 text-[10px] opacity-60">
            Entrez un pourcentage (ex: 20 pour 20%).
          </p>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="form-control">
          <label for="product_type_id" class="label py-1"><span class="label-text text-xs font-medium">Type de produit</span></label>
          <select id="product_type_id" name="product_type_id" class="select select-bordered select-sm" required>
            <option value="">‚Äî S√©lectionner ‚Äî</option>
            {{ range .ProductTypes }}
            <option value="{{ .ID }}">{{ .Name }}</option>
            {{ end }}
          </select>
          {{ if .Errors.product_type_id }}
          <span class="text-error text-xs mt-1">Type requis</span>
          {{ end }}
        </div>
        <div class="form-control">
          <label for="unit_type_id" class="label py-1"><span class="label-text text-xs font-medium">Unit√© de mesure</span></label>
          <select id="unit_type_id" name="unit_type_id" class="select select-bordered select-sm" required>
            <option value="">‚Äî S√©lectionner ‚Äî</option>
            {{ range .UnitTypes }}
            <option value="{{ .ID }}">{{ .Name }} ({{ .Symbol }})</option>
            {{ end }}
          </select>
          {{ if .Errors.unit_type_id }}
          <span class="text-error text-xs mt-1">Unit√© requise</span>
          {{ end }}
        </div>
      </div>
      <div class="modal-action">
        <button type="submit" id="submitBtn" class="btn btn-primary btn-sm">Cr√©er</button>
        <button
          type="button"
          class="btn btn-ghost btn-sm"
          onclick="productModal.close()"
        >
          Annuler
        </button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button title="Fermer">close</button>
  </form>
</dialog>
{{ end }}

<style>
  /* Inline utility approximations (since Tailwind @apply isn't processed in templates) */
  .stat-card {
    background: var(--b1);
    border: 1px solid var(--b3, rgba(0, 0, 0, 0.08));
    padding: 1rem;
    border-radius: 0.75rem;
  }
  .stat-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.6;
    margin-bottom: 0.25rem;
  }
  .stat-value {
    font-size: 1.25rem;
    font-weight: 600;
  }
</style>

<script>
  function filterProducts() {
    const q = document.getElementById("prodFilter").value.toLowerCase();
    document.querySelectorAll("#prodRows tr").forEach((tr) => {
      if (!q) {
        tr.style.display = "";
        return;
      }
      const txt = tr.textContent.toLowerCase();
      tr.style.display = txt.includes(q) ? "" : "none";
    });
  }
  function openEdit(btn){
    const tr = btn.closest('tr');
    if(!tr) return;
    const id = tr.dataset.id;
    const name = tr.dataset.name;
    const code = tr.dataset.code;
    const price = tr.dataset.price;
    const vat = tr.dataset.vat;
    document.getElementById('modalTitle').textContent = 'Modifier produit';
    const form = document.getElementById('productForm');
    form.action = '/products/update?id=' + encodeURIComponent(id);
    document.getElementById('name').value = name;
    document.getElementById('code').value = code;
    document.getElementById('code').readOnly = true; // immutable
    document.getElementById('unit_price').value = price;
    document.getElementById('vat_rate').value = vat;
    document.getElementById('submitBtn').textContent = 'Enregistrer';
    productModal.showModal();
  }
  // Reset modal when closed (best-effort)
  document.addEventListener('close', function(e){ if(e.target.id==='productModal'){ resetForm(); }}, true);
  function resetForm(){
    const form = document.getElementById('productForm');
    form.action = '/products';
    form.reset();
    document.getElementById('code').readOnly = false;
    document.getElementById('submitBtn').textContent = 'Cr√©er';
    document.getElementById('modalTitle').textContent = 'Nouveau produit';
  }
</script>
{{ end }}
