package i18n

import (
	"context"
	"strings"
)

// Simple in-memory translation map.
//
//nolint:misspell // keys/values include French text and accents by design
var translations = map[string]map[string]string{
	"fr": {
		"required":                    "Requis",
		"company_settings":		"Paramètres de l'entreprise",
		"company_settings_help":	"Ces informations apparaîtront sur vos factures.",
		"general_information":	"Informations générales",
		"company_name":		"Nom de l'entreprise",
		"save_settings":		"Enregistrer les paramètres",
		"street_address":		"Adresse",
		"city":				"Ville",
		"postal_code":			"Code postal",
		"country":			"Pays",
		"phone":			"Téléphone",
		"email":			"Email",
		"website":			"Site web",
		"siret":			"SIRET",
		"vat_number":			"N° de TVA",
		"rcs":				"RCS",
		"capital":			"Capital social",
		"logo_url":			"URL du logo",
		"siret_length":                "Doit contenir 14 chiffres",
		"siret_digits":                "Doit contenir uniquement des chiffres",
		"tva_rate_invalid":            "Taux invalide",
		"dashboard_title":             "Tableau de bord",
		"dashboard_company_fallback":  "Votre Entreprise",
		"nav_settings":                "Paramètres",
		"nav_logout":                  "Déconnexion",
		"dashboard_welcome_prefix":    "Bienvenue",
		"dashboard_overview":          "Voici un aperçu rapide de votre compte.",
		"company_profile_title":       "Profil Entreprise",
		"company_not_configured":      "Pas encore de configuration.",
		"company_complete_setup":      "Compléter le paramétrage",
		"quick_actions_title":         "Actions rapides",
		"action_new_invoice":          "Nouvelle facture",
		"action_clients":              "Clients",
		"action_reports":              "Rapports",
		"stats_title":                 "Statistiques",
		"stats_invoices":              "Factures",
		"stats_clients":               "Clients",
		"stats_products":              "Produits",
		"recent_products_title":       "Produits récents",
		"no_products":                 "Aucun produit.",
		"recent_invoices_title":       "Factures récentes",
		"no_invoices":                 "Aucune facture.",
		"shortcuts_title":             "Raccourcis",
		"shortcut_edit_company":       "Modifier l'entreprise",
		"shortcut_profile":            "Mon profil / Mot de passe",
		"shortcut_view_invoices":      "Voir les factures",
		"shortcut_account_settings":   "Paramètres du compte",
		"theme_toggle":                "Thème",
		"profile_title":               "Mon profil",
		"profile_change_password":     "Changer le mot de passe",
		"profile_current_password":    "Mot de passe actuel",
		"profile_new_password":        "Nouveau mot de passe",
		"profile_confirm_password":    "Confirmer",
		"profile_update_button":       "Mettre à jour",
		"profile_back":                "Retour",
		"landing_title":               "Billing App - Accueil",
		"nav_dashboard":               "Dashboard",
		"nav_products":                "Produits",
		"nav_invoices":                "Factures",
		"nav_clients":                 "Clients",
		"nav_login":                   "Connexion",
		"nav_signup":                  "Inscription",
		"nav_language":                "Langue",
		"landing_hero_title":          "Simplifiez votre facturation.",
		"landing_hero_subtitle":       "Billing App vous aide à gérer vos produits, générer des factures PDF professionnelles et suivre votre activité sans complexité.",
		"landing_cta_setup":           "Configurer l'application",
		"landing_cta_products":        "Voir les produits",
		"landing_feat_products_title": "Catalogue produits",
		"landing_feat_products_body":  "Centralisez vos produits et services avec prix HT & TVA.",
		"landing_feat_invoices_title": "Factures PDF",
		"landing_feat_invoices_body":  "Génération rapide de factures conformes et export en un clic.",
		"landing_feat_setup_title":    "Paramétrage simple",
		"landing_feat_setup_body":     "Configurez votre entreprise en quelques champs seulement.",
		"home_tagline_title":          "Accélérez votre facturation.",
		"home_tagline_sub":            "Produits, clients, factures PDF et TVA : tout en un seul outil clair.",
		"home_highlight_products":     "Créez et réutilisez vos produits avec prix HT / TVA.",
		"home_highlight_invoices":     "Générez des factures PDF conformes en quelques clics.",
		"home_highlight_custom":       "Personnalisez le thème, la langue et les modèles.",
		"home_section_all_need":       "Tout ce dont vous avez besoin",
		"home_list_products":          "Produits & clients CRUD",
		"home_list_vat":               "Calcul TVA intégré",
		"home_list_templates":         "Modèles de vues",
		"home_list_theme":             "Thème clair / sombre",
		"home_list_i18n":              "Interface multilingue",
		"home_cta_get_started":        "Commencer",
		"home_cta_sign_in":            "Se connecter",
		"home_meta_desc":              "Application de facturation simple : produits, clients, factures PDF et TVA avec interface multilingue et thème sombre.",
		"home_hero_alt_dashboard":     "Aperçu du tableau de bord",
		"home_hero_alt_invoice":       "Aperçu facture PDF",
		"flash_form_invalid":          "Formulaire invalide",
		"flash_user_not_found":        "Utilisateur introuvable",
		"flash_password_current_bad":  "Mot de passe actuel invalide",
		"flash_password_mismatch":     "Nouveau mot de passe invalide ou non confirmé",
		"flash_password_save_error":   "Erreur lors de la sauvegarde du mot de passe",
		"flash_password_saved":        "Mot de passe mis à jour",
		// Invoices page
		"invoices.title":      "Factures",
		"invoices.refresh":    "Rafraîchir",
		"invoices.empty":      "Aucune facture.",
		"invoices.no_company": "Aucune société configurée.",
		// Admin - Profiles
		"nav_admin":                   "Administration",
		"nav_admin_profiles":          "Profils",
		"nav_admin_users":             "Utilisateurs",
		"admin_profiles_title":        "Gestion des profils",
		"admin_profiles_new":          "Nouveau profil",
		"admin_profiles_edit":         "Modifier le profil",
		"admin_profiles_permissions":  "Permissions",
		"admin_profiles_empty":        "Aucun profil configuré.",
		"profile_name":                "Nom",
		"profile_name_placeholder":    "Ex: Comptable, Manager...",
		"profile_description":         "Description",
		"profile_description_placeholder": "Description du rôle",
		"profile_permissions_count":   "Permissions",
		"profile_users_count":         "Utilisateurs",
		"profile_system":              "Système",
		"profile_edit_permissions":    "Permissions",
		// Admin - Users
		"admin_users_title":           "Gestion des utilisateurs",
		"admin_users_empty":           "Aucun utilisateur.",
		"user_email":                  "Email",
		"user_name":                   "Nom",
		"user_profile":                "Profil",
		"no_profile":                  "Sans profil",
		"select_profile":              "Sélectionner un profil",
		"assign":                      "Assigner",
		// Common
		"yes":                         "Oui",
		"no":                          "Non",
		"edit":                        "Modifier",
		"delete":                      "Supprimer",
		"save":                        "Enregistrer",
		"create":                      "Créer",
		"cancel":                      "Annuler",
		"back":                        "Retour",
		"actions":                     "Actions",
		"confirm_delete":              "Êtes-vous sûr de vouloir supprimer ?",
		"select_all":                  "Tout sélectionner",
		"deselect_all":                "Tout désélectionner",
		"save_permissions":            "Enregistrer les permissions",
	},
	"en": {
		"required":                    "Required",
		"siret_length":                "Must be exactly 14 digits",
		"siret_digits":                "Digits only",
		"tva_rate_invalid":            "Invalid VAT rate",
		"dashboard_title":             "Dashboard",
		"dashboard_company_fallback":  "Your Company",
		"nav_settings":                "Settings",
		"nav_logout":                  "Logout",
		"dashboard_welcome_prefix":    "Welcome back",
		"dashboard_overview":          "Here's a quick overview of your account.",
		"nav_clients":                 "Clients",
		"company_profile_title":       "Company Profile",
		"company_not_configured":      "No company settings yet.",
		"company_complete_setup":      "Complete setup",
		"quick_actions_title":         "Quick Actions",
		"action_new_invoice":          "New Invoice",
		"action_clients":              "Clients",
		"action_reports":              "Reports",
		"stats_title":                 "Stats",
		"stats_invoices":              "Invoices",
		"stats_clients":               "Clients",
		"stats_products":              "Products",
		"recent_products_title":       "Recent Products",
		"no_products":                 "No products yet.",
		"recent_invoices_title":       "Recent Invoices",
		"no_invoices":                 "No invoices yet.",
		"shortcuts_title":             "Shortcuts",
		"shortcut_edit_company":       "Edit company profile",
		"shortcut_profile":            "My profile / Password",
		"shortcut_view_invoices":      "View invoices",
		"shortcut_account_settings":   "Account settings",
		"theme_toggle":                "Theme",
		"profile_title":               "My profile",
		"profile_change_password":     "Change password",
		"profile_current_password":    "Current password",
		"profile_new_password":        "New password",
		"profile_confirm_password":    "Confirm",
		"profile_update_button":       "Update",
		"profile_back":                "Back",
		"landing_title":               "Billing App - Home",
		"nav_dashboard":               "Dashboard",
		"nav_products":                "Products",
		"nav_invoices":                "Invoices",
		"nav_login":                   "Login",
		"nav_signup":                  "Sign up",
		"nav_language":                "Language",
		"landing_hero_title":          "Simplify your billing.",
		"landing_hero_subtitle":       "Billing App helps you manage products, generate professional PDF invoices and track activity without complexity.",
		"landing_cta_setup":           "Configure the app",
		"landing_cta_products":        "Browse products",
		"landing_feat_products_title": "Product catalog",
		"landing_feat_products_body":  "Centralize your products & services with net price & VAT.",
		"landing_feat_invoices_title": "PDF invoices",
		"landing_feat_invoices_body":  "Fast compliant invoice generation & one‑click export.",
		"landing_feat_setup_title":    "Easy setup",
		"landing_feat_setup_body":     "Set up your company in just a few fields.",
		"home_tagline_title":          "Accelerate your billing.",
		"home_tagline_sub":            "Products, clients, PDF invoices & VAT in one focused tool.",
		"home_highlight_products":     "Create & reuse products with net/VAT pricing.",
		"home_highlight_invoices":     "Generate compliant PDF invoices quickly.",
		"home_highlight_custom":       "Customize theme, language & templates.",
		"home_section_all_need":       "Everything you need",
		"home_list_products":          "Product & client CRUD",
		"home_list_vat":               "Built‑in VAT math",
		"home_list_templates":         "Template based views",
		"home_list_theme":             "Light / dark theme",
		"home_list_i18n":              "i18n ready UI",
		"home_cta_get_started":        "Get Started",
		"home_cta_sign_in":            "Sign In",
		"home_meta_desc":              "Simple billing app: products, clients, PDF invoices & VAT with multi-language UI and dark theme.",
		"home_hero_alt_dashboard":     "Dashboard preview",
		"home_hero_alt_invoice":       "Invoice preview",
		"flash_form_invalid":          "Invalid form",
		"flash_user_not_found":        "User not found",
		"flash_password_current_bad":  "Current password incorrect",
		"flash_password_mismatch":     "New password invalid or confirmation mismatch",
		"flash_password_save_error":   "Error saving password",
		"flash_password_saved":        "Password updated",
		// Invoices page
		"invoices.title":      "Invoices",
		"invoices.refresh":    "Refresh",
		"invoices.empty":      "No invoices yet.",
		"invoices.no_company": "No company configured.",
		// Admin - Profiles
		"nav_admin":                   "Admin",
		"nav_admin_profiles":          "Profiles",
		"nav_admin_users":             "Users",
		"admin_profiles_title":        "Profile Management",
		"admin_profiles_new":          "New Profile",
		"admin_profiles_edit":         "Edit Profile",
		"admin_profiles_permissions":  "Permissions",
		"admin_profiles_empty":        "No profiles configured.",
		"profile_name":                "Name",
		"profile_name_placeholder":    "e.g. Accountant, Manager...",
		"profile_description":         "Description",
		"profile_description_placeholder": "Role description",
		"profile_permissions_count":   "Permissions",
		"profile_users_count":         "Users",
		"profile_system":              "System",
		"profile_edit_permissions":    "Permissions",
		// Admin - Users
		"admin_users_title":           "User Management",
		"admin_users_empty":           "No users found.",
		"user_email":                  "Email",
		"user_name":                   "Name",
		"user_profile":                "Profile",
		"no_profile":                  "No profile",
		"select_profile":              "Select a profile",
		"assign":                      "Assign",
		// Common
		"yes":                         "Yes",
		"no":                          "No",
		"edit":                        "Edit",
		"delete":                      "Delete",
		"save":                        "Save",
		"create":                      "Create",
		"cancel":                      "Cancel",
		"back":                        "Back",
		"actions":                     "Actions",
		"confirm_delete":              "Are you sure you want to delete?",
		"select_all":                  "Select all",
		"deselect_all":                "Deselect all",
		"save_permissions":            "Save permissions",
	},
}

// DetectLanguage returns 'en' or 'fr' (default fr) from Accept-Language header.
func DetectLanguage(header string) string {
	h := strings.ToLower(header)
	if strings.HasPrefix(h, "en") {
		return "en"
	}
	return "fr"
}

// T translates a code into given lang, falling back to fr then code.
func T(lang, code string) string {
	if m, ok := translations[lang]; ok {
		if v, ok2 := m[code]; ok2 {
			return v
		}
	}
	if m, ok := translations["fr"]; ok {
		if v, ok2 := m[code]; ok2 {
			return v
		}
	}
	return code
}

// Context key for language
type langKey struct{}

// WithLang returns a new context with the given language.
func WithLang(ctx context.Context, lang string) context.Context {
	return context.WithValue(ctx, langKey{}, lang)
}

// LangFromContext retrieves the language from context, defaulting to "fr".
func LangFromContext(ctx context.Context) string {
	if lang, ok := ctx.Value(langKey{}).(string); ok {
		return lang
	}
	return "fr"
}
